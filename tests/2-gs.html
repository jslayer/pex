<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div id="test">
    <h1>{{ title }}</h1>

    <p>{{ users }}</p>

    <input type="text" a2-model="title" />
    <input type="text" a2-model="title" />

    <input type="text" a2-enter="onEnterHandler" />

    <ul a2-for="user, i in users">
        <li>{{ i }} : {{ user.id }} : <b>{{ user.name }}</b></li>
    </ul>
</div>
<script>
    var Plugins = {},
        A2, a2;

    /**
     * @param {Object?} cfg
     * @constructor
     */
    function Base(cfg){
        var args = arguments,
            l = this,
            i,
            _attrs = {};

        this._listeners = {};

        //create parents chain
        this._chain = [];

        do {
            this._chain.unshift(l);
        } while (l = l.constructor.__super__);

        //collect & process ATTRS information
        this._chain.map(function(o){
            var i,
                attrs = o.constructor.ATTRS;

            if (attrs) {
                for (i in attrs) {
                    _attrs[i] = attrs[i];
                }
            }
        }, this);

        for (i in cfg) {
            if (!_attrs[i]) {
                _attrs[i] = {};
            }
            _attrs[i].value = cfg[i];
        }

        for (i in _attrs) {
            this._define(i, _attrs[i]);
        }

        for (i = 0, l = this._exs.length; i < l; i++) {
            this._exs[i].apply(this, arguments);
        }

        this._plugins = [];

        //call initializer of each chain item
        this._chain.map(function(o){
            if (o.initializer) {
                o.initializer.apply(this, args);
            }
        }, this);
    }

    /**
     * @param {string} name
     * @param {Function} P
     * @param {Object?} px
     * @param {Object?} sx
     * @returns {Function}
     */
    Base.extend = function(name, P, ex, px, sx){
        var C, F, i, l, ii;

        F = function(){
        };

        C = function(){
            P.apply(this, arguments);
        };

        F.prototype = P.prototype;
        C.prototype = new F();

        for (i in sx) {
            C[i] = sx[i];
        }

        C.prototype._exs = ex;

        //extend the prototype with method from extensions
        for (i = 0, l = ex.length; i < l; i++) {
            for (ii in ex[i].prototype) {
                if (ex[i].prototype.hasOwnProperty(ii)) {
                    C.prototype[ii] = ex[i].prototype[ii];
                }
            }
        }

        for (i in px) {
            C.prototype[i] = px[i];
        }

        C.__super__ = P.prototype;
        C.prototype.constructor = C;
        C.NAME = name;

        return C;
    };

    /**
     * @type {{on: Function, off: Function}}
     */
    Base.Node = {
        /**
         * @param node
         * @param type
         * @param fn
         * @param capture
         * @returns {*}
         */
        on  : function(node, type, fn, capture){
            var i, l, types;

            types = type.split(' ');

            for (i = 0, l = types.length; i < l; i++) {
                node.addEventListener(types[i], fn, capture || false);
            }

            return this;
        },
        /**
         * @param node
         * @param type
         * @param fn
         * @param capture
         * @returns {*}
         */
        off : function(node, type, fn, capture){
            var i, l, types;

            types = type.split(' ');

            for (i = 0, l = types; i < l; i++) {
                node.removeEventListener(types[i], fn, capture || false);
            }

            return this;
        }
    };

    /**
     * @param {string} name
     * @param {object?} attrs
     * @private
     */
    Base.prototype._define = function(name, attrs){
        var value, _set, _get;

        Object.defineProperty(this, name, {
            set : function(nv){
                var old = value;

                value = _set ? _set.call(this, nv, name) : nv;

                this.emit({
                    name   : name,
                    type   : 'change',
                    data   : {
                        newVal : nv,
                        oldVal : old
                    },
                    target : this
                });

                re.call(this, value, name);

                return value;
            },
            get : function(){
                return _get ? _get.call(this, value, name) : value;
            }
        });

        if (attrs) {
            if (attrs.value) {
                if (Object.prototype.toString.call(attrs.value) === '[object Object]') {
                    this[name] = Object.create(attrs.value);
                }
                else {
                    this[name] = attrs.value;
                }
            }
        }

        function re(o, pName){
            var i,
                self = this;

            switch (Object.prototype.toString.call(o)) {
                case '[object Object]':
                    for (i in o) {
                        (function(){
                            var value = o[i],
                                name = [pName, i].join('.');

                            Object.defineProperty(o, i, {
                                get : function(){
                                    return _get ? _get.call(self, value, name) : value;
                                },
                                set : function(nv){
                                    var old = value;

                                    value = _set ? _set.call(this, nv, name) : nv;

                                    self.emit({
                                        name   : name,
                                        type   : 'change',
                                        data   : {
                                            newVal : nv,
                                            oldVal : old
                                        },
                                        target : self
                                    });

                                    re.call(self, value, name);

                                    return value;
                                }
                            });

                            o[i] = value;
                        })();
                    }
                    break;
                case '[object Array]':
                    o.pop = function(){
                        var out;

                        out = Array.prototype.pop.apply(this, arguments);

                        self.emit({
                            name   : pName,
                            type   : 'pop',
                            data   : {
                                newVal : this
                            },
                            target : self
                        });

                        rea(self, o, pName);

                        return out;
                    };

                    o.push = function(){
                        var out;

                        out = Array.prototype.push.apply(this, arguments);

                        self.emit({
                            name   : pName,
                            type   : 'push',
                            data   : {
                                newVal : Array.prototype.slice.call(this, 0)
                            },
                            target : self
                        });

                        rea(self, o, pName);

                        return out;
                    };

                    o.reverse = function(){
                        //todo - implement
                        return Array.prototype.reverse.apply(this, arguments);
                    };

                    o.shift = function(){
                        //todo - implement
                        return Array.prototype.shift.apply(this, arguments);
                    };

                    o.sort = function(){
                        //todo - implement
                        return Array.prototype.sort.apply(this, arguments);
                    };

                    o.splice = function(){
                        //todo - implement
                        return Array.prototype.splice.apply(this, arguments);
                    };

                    o.unshift = function(){
                        //todo - implement
                        return Array.prototype.unshift.apply(this, arguments);
                    };

                    rea(self, o, pName);

                    break;
            }
        }

        function rea(self, o, pName){
            var l, i;

            for (i = 0, l = o.length; i < l; i++) {
                re.call(self, o[i], [pName, i].join('.'));
            }
        }

        return this;
    };

    /**
     * @param {string} name
     * @param {Function} cb
     * @param {object?} context
     * @returns {{cb: *, ctx: *}}
     */
    Base.prototype.listen = function(name, cb, context){
        if (!this._listeners[name]) {
            this._listeners[name] = [];
        }

        var listener = {
            cb  : cb,
            ctx : context
        };

        this._listeners[name].push(listener);

        return listener;
    };

    Base.prototype.emit = function(e){
        if (e.type === 'change' && e.data.newVal === e.data.oldVal) {
            return;
        }
        var listeners = this._listeners[e.name];

        if (listeners) {
            listeners.forEach(function(ltr){
                ltr.cb.call(ltr.ctx || this, e);
            }, this);
        }
    };

    Base.prototype.detach = function(listener){
        //todo - implement
    };

    /*** ----------------------------------- ***/

    /**
     * Plugin extension
     * @constructor
     */
    function Plugin(){
        //console.log('PLUGIN EXTENSION');
    }

    Plugin.prototype.plug = function(C){
        this._plugins.push(C.NAME);

        this[C.NAME] = new C(this, arguments[1]);
    };

    A2 = Base.extend('A2', Base, [Plugin], {
        initializer : function(){

        },

        init : function(){
            this.processTree(
                this.parse(this.node)
            );
        },

        processTree : function(tree){
            var i;

            if (tree.cfg) {
                for (i in tree.cfg) {
                    this[i].process(tree, tree.cfg[i]);
                }
            }

            if (tree.children) {
                for (i in tree.children) {
                    this.processTree(tree.children[i]);
                }
            }

        },

        parse : function(node, parent){
            var i, l, tree, child, children, go, notDive;

            tree = {
                node   : node,
                parent : parent || false
            };

            notDive = this._plugins.some(function(name){
                var plugin = this[name];

                return plugin && plugin.validate ? plugin.validate(tree) : false;
            }, this);

            children = node.childNodes;

            if (!notDive && children && children.length > 0) {
                tree.children = [];

                for (i = 0, l = children.length; i < l; i++) {
                    child = children[i];

                    go = false;

                    switch (child.nodeType) {
                        case 1://Element Node
                            go = true;
                            break;
                        case 3://Text Node
                            if (child.textContent.trim().length > 0) {
                                go = true;
                            }
                            break;
                    }

                    if (go) {
                        tree.children.push(
                            this.parse(child, tree)
                        );
                    }
                }
            }

            return tree;
        },

        /**
         * @param tree
         * @param plugin
         * @param data
         */
        setConfig : function(tree, plugin, data){
            if (!tree.cfg) {
                tree.cfg = {};
            }

            tree.cfg[plugin.constructor.NAME] = data;
        },

        /**
         * @param tree
         * @param plugin
         * @returns {boolean}
         */
        getConfig : function(tree, plugin){
            var result = false;

            if (tree.cfg && tree.cfg[plugin.constructor.NAME]) {
                result = tree.cfg[plugin.constructor.NAME];
            }

            return result;
        }
    }, {
        ATTRS  : {
            node : null
        },
        PREFIX : 'a2'
    });

    a2 = new A2({
        node : document.getElementById('test')
    });

    function PluginBase(){
        this.host = arguments[0];

        if (this.initializer) {
            this.initializer.apply(this, arguments);
        }
    }

    Plugins.PluginNodeForIn = Base.extend('PluginNodeForIn', PluginBase, [], {
        validate : function(tree){
            var result = false,
                node = tree.node,
                attrValue = node.getAttribute && node.getAttribute([
                    this.host.constructor.PREFIX,
                    this.constructor.SUFFIX
                ].join('-'));

            if (attrValue) {
                this._pre(tree, attrValue);
                result = true;
            }

            return result;
        },

        _pre : function(tree, value){
            //>   user, i in users    <
            //> single[, key] in list <
            var parts = value.match(/(\w+)\s*(?:,\s*(.))?\s+in\s+(\w+)/).slice(1);

            this.host.setConfig(tree, this, {
                parts : {
                    name  : parts[0],
                    key   : parts[1],
                    model : parts[2]
                },
                tpl   : Array.prototype.splice.call(tree.node.childNodes, 0)
            });

            tree.node.innerHTML = '';
        },

        process : function(tree, cfg){
            //console.log('PPPP');
            //todo - implement
            console.log(cfg);
        },
        generate : function() {

        }
    }, {
        SUFFIX : 'for'
    });

    Plugins.PluginNodeText = Base.extend('PluginNodeText', PluginBase, [], {
        validate : function(tree){
            var i, ii, ll, child, texts, frag, match;

            switch (tree.node.nodeType) {
                case 1://Node
                    /**
                     * Go through the child & split texts into parts
                     */

                    for (i = tree.node.childNodes.length - 1; i >= 0; i--) {
                        child = tree.node.childNodes[i];

                        if (child.nodeType === 3) {

                            frag = document.createDocumentFragment();

                            texts = child.textContent.split(/({{\s*\w+\s*}})/g);
                            for(ii=0, ll = texts.length; ii < ll; ii++) {
                                if (texts[ii].trim().length) {
                                    frag.appendChild(document.createTextNode(texts[ii]));
                                }
                            }

                            tree.node.replaceChild(frag, child);
                        }
                    }
                    break;
                case 3:
                    match = tree.node.textContent.match(/{{\s*([a-z.-9]+)\s*}}/);//todo - change

                    if (match && match.length === 2) {
                        this.host.setConfig(tree, this, match[1]);

                        tree.node.textContent = '';
                    }
                    break;
            }
        },
        process  : function(tree, modelName){
            if (!(modelName in this.host)) {
                this.host._define(modelName)
            }

            this.host.listen(modelName, function(e){
                tree.node.textContent = e.data.newVal;
            });
        }
    });

    Plugins.PluginNodeInput = Base.extend('PluginNodeInput', PluginBase, [], {
        validate : function(tree){
            if (tree.node.tagName === 'INPUT') {
                var model = tree.node.getAttribute([
                    this.host.constructor.PREFIX,
                    this.constructor.SUFFIX
                ].join('-'));

                if (model) {
                    this.host.setConfig(tree, this, model);
                }
            }
        },

        process : function(tree, modelName){
            if (!(modelName in this.host)) {
                this.host._define(modelName)
            }

            var host = this.host;

            Base.Node.on(tree.node, 'keyup input', function(e){
                host[modelName] = e.target.value;
            });

            this.host.listen(modelName, function(e){
                tree.node.value = e.data.newVal;
            });
        }
    }, {
        SUFFIX : 'model'
    });

    Plugins.PluginNodeEnter = Base.extend('PluginNodeEnter', PluginBase, [], {
        validate : function(tree) {
            if (tree.node.nodeType === 1) {
                var enter = tree.node.getAttribute([
                    this.host.constructor.PREFIX,
                    this.constructor.SUFFIX
                ].join('-'));

                if (enter) {
                    this.host.setConfig(tree, this, enter);
                }
            }
        },
        process : function(tree, enter) {
            var host = this.host;

            Base.Node.on(tree.node, 'keydown', function(e) {
                if (e.which === 13) {
                    if (typeof host[enter] === 'function') {
                        host[enter](tree);
                    }
                }
            });

        }
    }, {
        SUFFIX : 'enter'
    });

    a2.plug(Plugins.PluginNodeForIn);
    a2.plug(Plugins.PluginNodeText);
    a2.plug(Plugins.PluginNodeInput);
    a2.plug(Plugins.PluginNodeEnter);

    a2.onEnterHandler = function(tree) {
        var value = tree.node.value;

        if (value) {
            if (!this.users) {
                this.users = [];
            }

            this.users.push(value);

            tree.node.value = '';
        }
    };

    a2.init();
</script>
</body>
</html>
