<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div id="test">
    <ul a2-for="user, i in users">
        <li>{{ i }} : {{ user.id }} : <b>{{ user.name }}</b></li>
    </ul>
</div>
<script>
    /**
     * @param {Object?} cfg
     * @constructor
     */
    function Base(cfg){
        var args = arguments,
            l = this,
            i,
            _attrs = {};

        this._listeners = {};

        //create parents chain
        this._chain = [];

        do {
            this._chain.unshift(l);
        } while (l = l.constructor.__super__);

        //collect & process ATTRS information
        this._chain.map(function(o){
            var i,
                attrs = o.constructor.ATTRS;

            if (attrs) {
                for (i in attrs) {
                    _attrs[i] = attrs[i];
                }
            }
        }, this);

        for (i in cfg) {
            if (!_attrs[i]) {
                _attrs[i] = {};
            }
            _attrs[i].value = cfg[i];
        }

        for (i in _attrs) {
            this._define(i, _attrs[i]);
        }

        //call initializer of each chain item
        this._chain.map(function(o){
            if (o.initializer) {
                o.initializer.apply(this, args);
            }
        }, this);
    }

    /**
     * @param {string} name
     * @param {Base} P
     * @param {Object?} px
     * @param {Object?} sx
     * @returns {Function}
     */
    Base.extend = function(name, P, px, sx){
        var C, F, i;

        F = function(){
        };

        C = function(){
            P.apply(this, arguments);
        };

        F.prototype = P.prototype;
        C.prototype = new F();

        for (i in sx) {
            C[i] = sx[i];
        }

        for (i in px) {
            C.prototype[i] = px[i];
        }

        C.__super__ = P.prototype;
        C.prototype.constructor = C;
        C.prototype.name = name;

        return C;
    };

    /**
     * @param {string} name
     * @param {object?} attrs
     * @private
     */
    Base.prototype._define = function(name, attrs){
        var value, _set, _get;

        Object.defineProperty(this, name, {
            set : function(nv){
                var old = value;

                value = _set ? _set.call(this, nv, name) : nv;

                this.emit({
                    name   : name,
                    type   : 'change',
                    data   : {
                        newVal : nv,
                        oldVal : old
                    },
                    target : this
                });

                re.call(this, value, name);

                return value;
            },
            get : function(){
                return _get ? _get.call(this, value, name) : value;
            }
        });

        if (attrs) {
            if (attrs.value) {
                if (Object.prototype.toString.call(attrs.value) === '[object Object]') {
                    this[name] = Object.create(attrs.value);
                }
                else {
                    this[name] = attrs.value;
                }
            }
        }

        function re(o, pName){
            var i,
                self = this;

            switch (Object.prototype.toString.call(o)) {
                case '[object Object]':
                    for (i in o) {
                        (function(){
                            var value = o[i],
                                name = [pName, i].join('.');

                            Object.defineProperty(o, i, {
                                get : function(){
                                    return _get ? _get.call(self, value, name) : value;
                                },
                                set : function(nv){
                                    var old = value;

                                    value = _set ? _set.call(this, nv, name) : nv;

                                    self.emit({
                                        name   : name,
                                        type   : 'change',
                                        data   : {
                                            newVal : nv,
                                            oldVal : old
                                        },
                                        target : self
                                    });

                                    re.call(self, value, name);

                                    return value;
                                }
                            });

                            o[i] = value;
                        })();
                    }
                    break;
                case '[object Array]':
                    o.pop = function(){
                        var out;

                        out = Array.prototype.pop.apply(this, arguments);

                        self.emit({
                            name   : pName,
                            type   : 'pop',
                            data   : {
                                newVal : this
                            },
                            target : self
                        });

                        rea(self, o, pName);

                        return out;
                    };

                    o.push = function(){
                        var out;

                        out = Array.prototype.push.apply(this, arguments);

                        self.emit({
                            name   : pName,
                            type   : 'push',
                            data   : {
                                newVal : Array.prototype.slice.call(this, 0)
                            },
                            target : self
                        });

                        rea(self, o, pName);

                        return out;
                    };

                    o.reverse = function(){
                        //todo - implement
                        return Array.prototype.reverse.apply(this, arguments);
                    };

                    o.shift = function(){
                        //todo - implement
                        return Array.prototype.shift.apply(this, arguments);
                    };

                    o.sort = function(){
                        //todo - implement
                        return Array.prototype.sort.apply(this, arguments);
                    };

                    o.splice = function(){
                        //todo - implement
                        return Array.prototype.splice.apply(this, arguments);
                    };

                    o.unshift = function(){
                        //todo - implement
                        return Array.prototype.unshift.apply(this, arguments);
                    };

                    rea(self, o, pName);

                    break;
            }
        }

        function rea(self, o, pName){
            var l, i;

            for (i = 0, l = o.length; i < l; i++) {
                re.call(self, o[i], [pName, i].join('.'));
            }
        }

        return this;
    };

    /**
     * @param {string} name
     * @param {Function} cb
     * @param {object?} context
     * @returns {{cb: *, ctx: *}}
     */
    Base.prototype.listen = function(name, cb, context){
        if (!this._listeners[name]) {
            this._listeners[name] = [];
        }

        var listener = {
            cb  : cb,
            ctx : context
        };

        this._listeners[name].push(listener);

        return listener;
    };

    Base.prototype.emit = function(e){
        if (e.type === 'change' && e.data.newVal === e.data.oldVal) {
            return;
        }
        var listeners = this._listeners[e.name];

        if (listeners) {
            listeners.forEach(function(ltr){
                ltr.cb.call(ltr.ctx || this, e);
            }, this);
        }
    };

    Base.prototype.detach = function(listener){
        //todo - implement
    };

    /*** ----------------------------------- ***/

    var A2 = Base.extend('A2', Base, {
        initializer : function(){
            //console.log(this, arguments, this.node);

            console.log(
                this.parse(this.node)
            );
        },

        parse : function(node, parent){
            var i, l, tree, child, children, go;

            tree = {
                node   : node,
                parent : parent || false
            };

            //div  ? // collection info from plugins

            children = node.childNodes;

            if (children && children.length > 0) {
                tree.children = [];

                for (i = 0, l = children.length; i < l; i++) {
                    child = children[i];

                    go = false;

                    switch (child.nodeType) {
                        case 1://Element Node
                            go = true;
                            break;
                        case 3://Text Node
                            if (child.textContent.trim().length > 0) {
                                go = true;
                            }
                            break;
                    }

                    if (go) {
                        tree.children.push(
                            this.parse(child, tree)
                        );
                    }
                }
            }

            return tree;
        }
    }, {
        ATTRS : {
            node : null
        }
    });

    var a2 = new A2({
        node : document.getElementById('test')
    });

    /*var A = Base.extend('A', Base, null, {
        ATTRS : {
            users : {
                value : []
            },
            a     : {
                value : {
                    b : {
                        c : {
                            d : 30000
                        }
                    }
                }
            }
        }
    });

    var a = new A();

    a.listen('users', function(e){
        console.log('users', e.type, e.data);
    });

    a.listen('users.0.name', function(e){
        console.log('users.0.name', e.type, e.data);
    });

    a.listen('users.1.name', function(e){
        console.log('users.1.name', e.type, e.data);
    });

    a.listen('a.b.c.d', function(e){
        console.log('a.b.c.d', e.type, e.data);
    });

    a.listen('a.b.c', function(e) {
        console.log('a.b.c', e.type, e.data);
    });

    a.listen('a', function(e) {
        console.log('a', e.type, e.data);
    });

    a.users.push({
        id   : 1,
        name : 'admin'
    });

    a.users.push({
        id   : 2,
        name : 'user'
    });

    a.users[0].name = 'SuperAdmin';

    a.users[1].name = 'DefaultUser';

    a.a.b.c.d = 10;

    a.a.b.c = { t : 1 }

    a.a = 22;*/

</script>
</body>
</html>